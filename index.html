<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FRH PRO formulaire</title>

  <!-- Liens CSS pour Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet Draw + GeometryUtil -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>

  <!-- Scripts JS pour Leaflet et html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

  <!-- Votre CSS -->
  <style>
    /* ... votre CSS inchangé ... */
  </style>
</head>

<body>
  <div class="container">
    <h1 class="page-title">Formulaire pour saisie données FRH PRO</h1>

    <!-- (1) Formulaire de recherche d'adresse -->
    <form id="addressForm" onsubmit="return searchAddress(event);">
      <!-- ... -->
    </form>

    <!-- (2) Boutons dessin -->
    <button id="toggleDrawingButton">Activer le dessin (main levée)</button>
    <button id="toggleMeasureButton">Mesurer une surface</button> <!-- NOUVEAU -->

    <!-- (3) Zone carte + canvas -->
    <div id="map-container">
      <div id="map"></div>
      <canvas id="drawingCanvas"></canvas>
    </div>

    <!-- (4) Formulaire principal -->
    <form id="userForm">
      <!-- ... -->
      <!-- Champ à remplir automatiquement -->
      <label for="Surface toiture">Surface toiture (m²) :</label>
      <input
        type="number"
        id="Surface toiture"
        name="Surface toiture"
        placeholder="Entrez la surface de la toiture"
      />
      <!-- ... -->
    </form>

    <!-- (5) Boutons PDF + JSON -->
    <div style="margin-bottom:15px;">
      <!-- ... -->
    </div>
  </div>

<script>
  /***************************************************
   * 1) INITIALISER LA CARTE LEAFLET
   ***************************************************/
  const map = L.map("map").setView([48.8566, 2.3522], 18); // Paris par défaut
  const tileLayer = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
    maxZoom: 20,
    subdomains: ["mt0", "mt1", "mt2", "mt3"],
    attribution: "© Google",
  });
  tileLayer.addTo(map);

  /***************************************************
   * 2) DESSIN LIBRE SUR CANVAS (main levée)
   ***************************************************/
  const drawingCanvas = document.getElementById("drawingCanvas");
  const ctx = drawingCanvas.getContext("2d");
  const AdresseField = document.getElementById("Adresse");

  let drawing = false;
  let drawingEnabled = false;

  // Bouton pour dessin libre
  const toggleDrawingButton = document.getElementById("toggleDrawingButton");
  toggleDrawingButton.addEventListener("click", () => {
    drawingEnabled = !drawingEnabled;
    drawingCanvas.style.pointerEvents = drawingEnabled ? "auto" : "none";
    toggleDrawingButton.textContent = drawingEnabled
      ? "Désactiver le dessin"
      : "Activer le dessin (main levée)";
  });

  // Adapter la taille du canvas
  function resizeCanvas() {
    drawingCanvas.width = drawingCanvas.offsetWidth;
    drawingCanvas.height = drawingCanvas.offsetHeight;
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  // Gestion souris pour dessiner
  drawingCanvas.addEventListener("mousedown", (event) => {
    if (!drawingEnabled) return;
    drawing = true;
    ctx.beginPath();
    const rect = drawingCanvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    ctx.moveTo(x, y);
  });

  drawingCanvas.addEventListener("mouseup", () => {
    if (!drawingEnabled) return;
    drawing = false;
    ctx.beginPath();
  });

  drawingCanvas.addEventListener("mousemove", (event) => {
    if (!drawing || !drawingEnabled) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "red";

    const rect = drawingCanvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    ctx.lineTo(x, y);
    ctx.stroke();
  });

  /***************************************************
   * A) AJOUT DES OUTILS DE MESURE (Leaflet Draw)
   ***************************************************/
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: {
      marker: false,
      polyline: false,
      circle: false,
      circlemarker: false,
      polygon: true,
      rectangle: true
    },
    edit: {
      featureGroup: drawnItems
    }
  });

  let measureActive = false;
  const measureButton = document.getElementById('toggleMeasureButton');
  measureButton.addEventListener('click', () => {
    measureActive = !measureActive;
    if (measureActive) {
      map.addControl(drawControl);
      measureButton.textContent = 'Terminer la mesure';
    } else {
      map.removeControl(drawControl);
      measureButton.textContent = 'Mesurer une surface';
    }
  });

  // Lorsqu'une forme est créée (polygone ou rectangle)
  map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);

    if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
      // Récupérer les LatLng
      const latLngs = layer.getLatLngs()[0]; 
      const area = L.GeometryUtil.geodesicArea(latLngs); // en m²
      const areaRounded = Math.round(area * 100) / 100;

      alert(`Surface mesurée : ${areaRounded} m²`);
      document.getElementById("Surface toiture").value = areaRounded;
    }
  });

  /***************************************************
   * 3) RECHERCHE D'ADRESSE
   ***************************************************/
  async function searchAddress(event) {
    // ... votre code inchangé ...
  }

  /***************************************************
   * 4) EXPORT PDF (2 PAGES)
   ***************************************************/
  function saveMapAsPDF() {
    // ... votre code inchangé ...
  }

  /***************************************************
   * 5) SAUVEGARDER / CHARGER JSON
   ***************************************************/
  // ... votre code inchangé ...
</script>
</body>
</html>
